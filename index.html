<!DOCTYPE html>
<html>
<head>
	<title>Faical Recongition</title>
	<link rel="stylesheet" type="text/css" href="/css/style.css">
</head>
<body>

	<section id="content">
		

		<div id="status"></div>

		<canvas  height="0px" width="0px" id="overlay"></canvas>
		<video id="inputVideo" autoplay muted></video>
		
		<div hidden="true" id="buttons" class="button-group">
			<button onclick="detectSingleFace()">Find One Face</button>
			<button onclick="detectFaces()">Find Many Faces</button>
		</div>

		<div id="logs"></div>


		
		
		
	</section>
</body>
<script src="/js/face-api.js/dist/face-api.js" type="text/javascript"></script>

<script type="text/javascript">
	const MODEL_PATH = '/js/face-api.js/weights/';
	// Elements
	const video = document.getElementById("inputVideo");
	const canvas = document.getElementById("overlay");
	const canvasContext = canvas.getContext('2d');
	const logs = document.getElementById("logs");
	const statusDiv = document.getElementById("status");
	const buttonsDiv = document.getElementById("buttons");

	var date = new Date();

	const mtcnnForwardParams = {
	// number of scaled versions of the input image passed through the CNN
	  // of the first stage, lower numbers will result in lower inference time,
	  // but will also be less accurate
	  //maxNumScales: 10,
	  // scale factor used to calculate the scale steps of the image
	  // pyramid used in stage 1
	  //scaleFactor: 0.709,
	  // the score threshold values used to filter the bounding
	  // boxes of stage 1, 2 and 3
	  //scoreThresholds: [0.6, 0.7, 0.7],
	  // mininum face size to expect, the higher the faster processing will be,
	  // but smaller faces won't be detected
	  // limiting the search space to larger faces for webcam detection
	  minFaceSize: 50,
	}

	const MtcnnOptions = new faceapi.MtcnnOptions(mtcnnForwardParams);

	var models = {
		"Age and Gender": faceapi.nets.ageGenderNet.load(MODEL_PATH)
		"SSD MobileNet": faceapi.loadSsdMobilenetv1Model,
		"Face Landmarks": faceapi.loadFaceLandmarkModel,
		"Face Recognition": faceapi.loadFaceRecognitionModel,
		"Face Expression": faceapi.loadFaceExpressionModel,
		"MCTNN":faceapi.loadMtcnnModel,
	}

	var modelsToLoad = ["Age and Gender","Face Recognition","Face Expression","Face Landmarks"]

	var onStreamError = (err) =>{console.error(err)}

	function videoIniti(){
		
		setStatus("Loading video....", "info");
		if (navigator){
			console.info("Navigator:",navigator)
			let getMediaFunc = undefined;
			if (navigator.vendor.indexOf("Google") > -1){
				navigator.getUserMedia({video:{}},s=>{video.srcObject = s},onStreamError)
				return
			}else if (navigator.userAgent.indexOf("Mozilla/") == 0){
				navigator.mozGetUserMedia({video:{}},s=>{video.srcObject=s},onStreamError)
				return
			}
			document.getElementById("content").innerHTML = `<h2 class="error">Navigator Error </h2><p>Failed to get user media ${navigator.vendor}</p>`;
			console.error(`${navigator.vendor.indexOf("Google")} is not found as a vendor`)
		}else{
			document.getElementById("content").innerHTML = '<h2 class="error">Navigator is Not Supported</h2><p>Your browser is old and have navigator module. To solve this issue, kindly upgrade your browser</p>';
			
		}

	}

	async function init(){
		await videoIniti()
		
		modelsToLoad.forEach((modelName) => {
			console.log(modelName)
			if (modelName == undefined){
				await setStatus(`Loading ${mo[index]} Model ...`);
				await models[modelsToLoad[index]](MODEL_PATH);
			}
		}
		changeInputSize(224)
		buttonsDiv.style.hidden = "";
		setStatus("Ready To Detect Faces", "info");
	}

	async function run(){
		await init();
		while (true) {
			await setTimeout(async ()=> {await detectFaces()},2);
			continue;
		}
	}


	video.onresize = () => {
		video.width = video.videoWidth;
		video.height = video.videoHeight;

		canvas.width = video.width;
		canvas.height = video.height;
	}

	window.onresize = () =>{
		video.onresize();

	}

	async function detectFaces(){
		setStatus("Attempting to Detect Faces....")
		const results = await faceapi.detectAllFaces(video,MtcnnOptions)
			.withFaceLandmarks()
			.withAgeAndGender()
		removeStatus()
		await displayResults(results,"Mtcnn")
	}
	var removeStatus = () =>{statusDiv.innerHTML = ""}
	var setStatus = (text) =>{statusDiv.innerHTML = `<p class="info">${text}</p>`} 

	var logStatus = (text,type) => {
		logs.innerHTML = `
			<p class="${(type === undefined || typeof(type) !== "string") ? "info":type}">${date.toTimeString().split(" ")[0]} 
				>> ${(type === "error") ? "ERROR: "+text: text}
			</p>`+logs.innerHTML;
	}

	function validateResults(results){
		if(results == undefined){
			logStatus("Failed to Dectect Faces because Dectection Results is type of undefined.", "error")
			return false
		}else if (results.length == 0){
			logStatus("No Faces Dectected.","warning");
			return false
		}
		return true
	}

	async function displayResults(results){
		// Reset Canvas 
		canvasContext.clearRect(0,0,canvas.width,canvas.height);

		await setStatus("Validating Dectection Results....")
		validateResults(results);
		
		if (validateResults(results)){

			await logStatus("Found "+results.length.toString()+" Faces.","info");
			await setStatus("Resizing Faces....");

			results = faceapi.resizeResults(results, canvas)

			await setStatus("Rendering Detections....");
	      	faceapi.draw.drawDetections(canvas, results)

	      	for (var i = results.length - 1; i >= 0; i--) {
	      		await setStatus(`Rendering Face data ${i} out of ${results.length}`);
			    console.info(results[i])
			    renderResultDetails(results[i]);
			   	renderConfidence(results[i]);

			 }
	    }

      	statusDiv.innerHTML = ""
		
	}

	
	const SECONDS_IN_YEAR = 31556926;



	var parseGender = (res) => {
		if (res.gender == undefined){return `Gender: Not Found`}
		return `Gender: ${res.gender}`
	}

	var parseGenderConfidence = (res) => {
		if (res.gender == undefined){return ""}
		return `Gender Confidence:  (${faceapi.round(res.genderProbability,2)}) %`
	}

	var parseAge = (res) => {
		if(typeof(res.age) == "number" ){
			return 	`Age: ${faceapi.round(res.age, 0)}`
		}else if (res.age == undefined){
			return `Age: Not Found`;
		} 
		return `Age: Not A Number`
	}

	var parseBirthDate = (res) => {
		if (typeof(res.age) == "number"){
			return `Date of Birth: ${new Date().setTime(Date.now()-(res.age*SECONDS_IN_YEAR)).toDateString()}`
		}
		return ""
	}


	function renderConfidence(res){
		new faceapi.draw.DrawTextField(
			[`Confidence: ${faceapi.round(res.classScore,2)} %`],
		      res.detection.box.topLeft
		    ).draw(canvas)
	}

	function renderResultDetails(res){
		new faceapi.draw.DrawTextField([
				parseAge(res),
				parseGender(res),parseGenderConfidence(res),
				//parseBirthDate(res),

			],res.detection.box.topRight).draw(canvas)
	}


	run();
	
</script>
</html>